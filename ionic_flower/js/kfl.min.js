var app=angular.module("kfl",["ionic"]);app.config(function(b,c,a){b.tabs.position("bottom");c.state("start",{url:"/kflStart",templateUrl:"tpl/start.html"}).state("main",{url:"/kflMain",templateUrl:"tpl/main.html",controller:"mainCtrl"}).state("detail",{url:"/kflDetail/:did",templateUrl:"tpl/detail.html",controller:"detailCtrl"}).state("order",{url:"/kflOrder/:price",templateUrl:"tpl/order.html",controller:"orderCtrl"}).state("myOrder",{url:"/kflMyOrder",templateUrl:"tpl/myOrder.html",controller:"myOrderCtrl"}).state("settings",{url:"/kflSettings",templateUrl:"tpl/settings.html",controller:"settingsCtrl"}).state("cart",{url:"/kflCart",templateUrl:"tpl/cart.html",controller:"cartCtrl"});a.otherwise("/kflStart")});app.service("$kflHttp",["$ionicLoading","$http",function(a,b){this.sendRequest=function(c,d){a.show({template:"加载中.."});b.get(c).success(function(e){d(e);a.hide()})}}]);app.controller("bodyCtrl",["$scope","$state",function(a,b){a.jump=function(d,c){b.go(d,c)}}]);app.controller("mainCtrl",["$scope","$kflHttp",function(b,a){b.dishList=[];b.hasMore=true;b.inputTxt={kw:""};a.sendRequest("data/dish_getbypage.php",function(c){b.dishList=c});b.loadMore=function(){a.sendRequest("data/dish_getbypage.php?start="+b.dishList.length,function(c){if(c.length<5){b.hasMore=false}b.dishList=b.dishList.concat(c);b.$broadcast("scroll.infiniteScrollComplete")})};b.$watch("inputTxt.kw",function(d,c){console.log(d,c);if(d.length>0){a.sendRequest("data/dish_getbykw.php?kw="+d,function(e){console.log(e);if(e.length>0){b.dishList=e}})}})}]);app.controller("detailCtrl",["$scope","$kflHttp","$stateParams","$ionicPopup",function(b,a,c,d){console.log(c);a.sendRequest("data/dish_getbyid.php?did="+c.did,function(e){console.log(e);b.dish=e[0]});b.addToCart=function(){a.sendRequest("data/cart_update.php?uid=1&count=-1&did="+c.did,function(e){console.log(e);if(e.msg=="succ"){d.alert({template:"成功添加到购物车"})}})}}]);app.controller("orderCtrl",["$scope","$kflHttp","$stateParams","$httpParamSerializerJQLike",function(b,a,c,d){console.log(c);b.submitResult="";b.order={userid:1,user_name:"",sex:"",phone:"",addr:"",totalprice:c.price,cartDetail:sessionStorage.getItem("cartDetail")};b.submitOrder=function(){console.log(b.order);var e=d(b.order);console.log(e);a.sendRequest("data/order_add.php?"+e,function(f){console.log(f);if(f){if(f[0].msg=="succ"){b.submitResult="下单成功，订单编号为:"+f[0].oid}else{if(f.msg=="error"){b.submitResult="下单失败"}}}})}}]);app.controller("myOrderCtrl",["$scope","$kflHttp",function(b,a){b.orderList=[];var c=sessionStorage.getItem("phone");console.log(c);a.sendRequest("data/order_getbyuserid.php?userid=1",function(d){console.log(d);b.orderList=d.data})}]);app.controller("settingsCtrl",["$scope","$ionicModal",function(b,a){a.fromTemplateUrl("tpl/about.html",{scope:b}).then(function(c){b.aboutModal=c});b.showAbout=function(){b.aboutModal.show()};b.hideAbout=function(){b.aboutModal.hide()}}]);app.controller("cartCtrl",["$scope","$kflHttp","$ionicPopup",function(b,a,c){b.cart=[];b.editText="编辑";b.editEnanbled=true;b.toggleEditStatus=function(){if(b.editEnanbled){b.editText="完成"}else{b.editText="编辑"}b.editEnanbled=!b.editEnanbled};b.saveAndJump=function(){sessionStorage.setItem("cartDetail",angular.toJson(b.cart));b.jump("order",{price:b.sumAll()})};a.sendRequest("data/cart_select.php?uid=1",function(d){console.log(d);b.cart=d.data});b.sumAll=function(){var d=0;for(var e=0;e<b.cart.length;e++){var f=b.cart[e];d+=(f.price*f.dishCount)}return d};b.minusFromCart=function(d){var e=b.cart[d].dishCount;if(e>1){e--;a.sendRequest("data/cart_update.php?uid=1&did="+b.cart[d].did+"&count="+e,function(){b.cart[d].dishCount--})}};b.plusToCart=function(d){var e=b.cart[d].dishCount;e++;a.sendRequest("data/cart_update.php?uid=1&did="+b.cart[d].did+"&count="+e,function(f){b.cart[d].dishCount++})}}]);